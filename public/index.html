<html>
<head>
	<title>Feminist Phone</title>
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
	<link href="style.css" rel="stylesheet">
	
	<!--[if lt IE 8]><!-->
	<script src="ie7/ie7.js"></script>
	<link href="ie7/ie7.css" rel="stylesheet">
	<!--<![endif]-->

	<script src="/socket.io/socket.io.js"></script>
</head>
<body ng-app="app" ng-controller="FeministPhone">
	<div class="jumbotron">
		<div class="container">
			<h1>&#9792; Feminist Phone</h1>
			<h2><a href="tel:+15034271565"><i class="glyphicon glyphicon-phone-alt"></i> (503) 427-1565</a></h2>
			<h3><a href="https://github.com/konsumer/feminist-phone"><i class="glyphicon glyphicon-github"></i> make your own</a></h3>
		</div>
	</div>

	<div ng-show="texts.length" class="container">
		Here are the texts I have received, lately:
		<ul>
			<li ng-repeat="call in texts" class="call">
				<span class="text">{{call.textMessage}}</span> - <span class="callinfo">{{call.date | date : 'short'}} - {{call.city}}, {{call.state}} {{call.country}}</span><br>
				<span class="response">{{quotes[call.response].text}} - {{quotes[call.response].author}}</span>
			</li>
		</ul>
	</div>

	<div ng-show="calls.length" class="container">
		Here are the calls I have received, lately:
		<ul>
			<li ng-repeat="call in calls" class="call">
				<tinyplayer src="call.recordingUrl"></tinyplayer> - <span class="callinfo">{{call.date | date : 'short'}} - {{call.city}}, {{call.state}} {{call.country}}</span><br>
				<span class="response">{{quotes[call.response].text}} - {{quotes[call.response].author}}</span>
			</li>
		</ul>
	</div>

	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js"></script>
	<script>
		angular.module('app',[])
		
		.controller('FeministPhone', function ($scope, $http, socket) {
			$scope.calls = [];
			$scope.texts = [];
			$scope.quotes = {};

			socket.emit('ready');

			socket.on('message:text', function (message) {
				$scope.texts.push(message);
			});

			socket.on('message:call', function (message) {
				$scope.calls.push(message);
			});

			socket.on('quote:add', function (quote) {
				$scope.quotes[quote['_id']] = quote;
			});

			socket.on('quote:remove', function (quote) {
				$scope.quotes = $scope.quotes.filter(function(squote){
					return (quote['_id'] != squote['_id']);
				});
			});
		})
		
		/**
		 * small HTML5 audio player, 1 allowed to play per scope
		 * Usage: <tinyplayer src="'URL'"></tinyplayer>
		 */
		.directive('tinyplayer', function(){
			return {
				restrict: 'E',
				scope: {src:'=src'},
				
				template: '<div ng-click="playpause()" class="tinyplayer"><span class="pause glyphicon glyphicon-pause" ng-show="playing"></span><span class="play glyphicon glyphicon-play" ng-show="!playing"></span></div>',
				
				controller: function($scope, $rootScope){
					//  todo: polyfill for older browsers
					var audio = new Audio();
					audio.src = $scope.src;
					$scope.playing = false;

					audio.addEventListener('ended', function(event) {
						$scope.playing = false;
						$scope.$apply();
					});

					$scope.playpause = function(){
						$scope.playing = !$scope.playing;
						if ($scope.playing){
							$rootScope.$emit('tinyplayer', audio);
						}else{
							audio.pause();
						}
					}

					$rootScope.$on('tinyplayer', function(scope, aud) {
						aud.play();
						if (aud!= audio){
							$scope.playing = false;
							audio.pause();
							audio.currentTime =0;
						}
					});
				}
			};
		})

		// interact with socket.io for realtime updates
		.factory('socket', function ($rootScope) {
		  var socket = io.connect();
		  return {
		    on: function (eventName, callback) {
		      socket.on(eventName, function () {  
		        var args = arguments;
		        $rootScope.$apply(function () {
		          callback.apply(socket, args);
		        });
		      });
		    },
		    emit: function (eventName, data, callback) {
		      socket.emit(eventName, data, function () {
		        var args = arguments;
		        $rootScope.$apply(function () {
		          if (callback) {
		            callback.apply(socket, args);
		          }
		        });
		      })
		    }
		  };
		});
	</script>
</body>


</html>
